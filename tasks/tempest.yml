---
- name: Get image
  become: false
  get_url:
    url: "{{ img_url }}"
    dest: "/tmp/{{ img_url | basename }}"
    timeout: 30

- name: Install qemu-img
  package:
    name: qemu-img

- name: Convert image to raw format
  become: false
  command:
    cmd: "qemu-img convert -f qcow2 -O raw /tmp/{{ img_url | basename }} /tmp/{{ img_url | basename }}.raw"

# - name: Upload image to rally server
#   copy:
#     src: "/tmp/{{ img_url | basename }}.raw"
#     dest: "/tmp/{{ img_url | basename }}.raw"
#     owner: root
#     group: root
#     mode: '0644'

- include_tasks: tempest_verifiers.yml
  with_dict: "{{ clouds }}"
  handlers:
    - name: Reload Systemd Daemon
      systemd_service:
        daemon_reload: true
